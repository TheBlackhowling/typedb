name: Release Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.2.0)'
        required: true
        type: string
      summary:
        description: 'Brief summary of this version (optional)'
        required: false
        type: string
      key_changes:
        description: 'Key changes (one per line, optional)'
        required: false
        type: string
  pull_request:
    types: [closed]
  push:
    tags:
      - 'v*.*.*'

jobs:
  release-version:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Checkout TechnicalDocumentation (for action)
        uses: actions/checkout@v4
        with:
          repository: TheBlackHowling/TechnicalDocumentation
          path: technical-docs-action
          ref: main
          token: ${{ secrets.CHANGELOG_ACCESS_TOKEN }}
      
      - name: Set up inputs
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            COMMIT_SHA="${{ github.event.pull_request.merge_commit_sha }}"
            PR_NUMBER="${{ github.event.pull_request.number }}"
            PR_URL="${{ github.event.pull_request.html_url }}"
            # Normalize line endings: convert CRLF to LF to prevent bash errors when writing to GITHUB_ENV
            PR_BODY=$(printf '%s' "${{ github.event.pull_request.body }}" | sed 's/\r$//' | sed 's/\r/\n/g')
            VERSION=""
          elif [ "${{ github.event_name }}" == "push" ] && [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            COMMIT_SHA="${{ github.sha }}"
            VERSION="${GITHUB_REF#refs/tags/v}"
            PR_NUMBER=""
            PR_URL=""
            PR_BODY=""
          else
            COMMIT_SHA="${{ github.sha }}"
            VERSION="${{ github.event.inputs.version }}"
            PR_NUMBER=""
            PR_URL=""
            PR_BODY=""
          fi
          
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_ENV
          echo "pr_number=$PR_NUMBER" >> $GITHUB_ENV
          echo "pr_url=$PR_URL" >> $GITHUB_ENV
          echo "pr_body<<EOF" >> $GITHUB_ENV
          printf '%s\n' "$PR_BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      
      - name: Run changelog release action (from TechnicalDocumentation)
        id: run_changelog
        uses: ./technical-docs-action/.github/actions/changelog-release
        with:
          version: ${{ env.version }}
          pr_body: ${{ env.pr_body }}
          pr_number: ${{ env.pr_number }}
          pr_url: ${{ env.pr_url }}
          commit_sha: ${{ env.commit_sha }}
          event_name: ${{ github.event_name }}
          repository: ${{ github.repository }}
      
      - name: Debug changelog outputs
        if: always()
        run: |
          echo "=== Changelog Action Debug Output ==="
          echo "Event: ${{ github.event_name }}"
          echo "PR Number: ${{ env.pr_number }}"
          echo "Initial Version: '${{ env.version }}'"
          echo ""
          echo "Changelog action outputs:"
          echo "  has_content: '${{ steps.run_changelog.outputs.has_content }}'"
          echo "  version: '${{ steps.run_changelog.outputs.version }}'"
          echo "  changelog_source: '${{ steps.run_changelog.outputs.changelog_source }}'"
          echo "  version_bump: '${{ steps.run_changelog.outputs.version_bump }}'"
          echo ""
          echo "Commit step conditions:"
          if [ "${{ steps.run_changelog.outputs.has_content }}" == "true" ]; then
            echo "  ‚úÖ has_content == 'true'"
          else
            echo "  ‚ùå has_content != 'true' (actual: '${{ steps.run_changelog.outputs.has_content }}')"
          fi
          if [ -n "${{ steps.run_changelog.outputs.version }}" ]; then
            echo "  ‚úÖ version is not empty (actual: '${{ steps.run_changelog.outputs.version }}')"
          else
            echo "  ‚ùå version is empty"
          fi
          echo ""
          if [ "${{ steps.run_changelog.outputs.has_content }}" == "true" ] && [ -n "${{ steps.run_changelog.outputs.version }}" ]; then
            echo "‚úÖ Commit step WILL run"
          else
            echo "‚ùå Commit step will be SKIPPED"
            echo ""
            echo "Reason: The workflow only commits when there's changelog content AND a version."
            echo "This is expected behavior for PRs without changelog entries."
          fi
      
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
      
      - name: Get target branch
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
          elif [ "${{ github.event_name }}" == "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "TARGET_BRANCH=" >> $GITHUB_ENV
            exit 0
          else
            TARGET_BRANCH=${GITHUB_REF#refs/heads/}
          fi
          echo "TARGET_BRANCH=$TARGET_BRANCH" >> $GITHUB_ENV
      
      - name: Commit changes
        if: steps.run_changelog.outputs.has_content == 'true' && steps.run_changelog.outputs.version != ''
        run: |
          VERSION="${{ steps.run_changelog.outputs.version }}"
          CHANGELOG_SOURCE="${{ steps.run_changelog.outputs.changelog_source }}"
          
          if [ -z "$VERSION" ]; then
            echo "Error: Version not available"
            exit 1
          fi
          
          # Check if version file exists
          if [ ! -f "versions/$VERSION.md" ]; then
            echo "Error: Version file not created: versions/$VERSION.md"
            exit 1
          fi
          
          git add versions/$VERSION.md
          git add CHANGELOG.md
          if [ "$CHANGELOG_SOURCE" == "unreleased" ]; then
            git add versions/unreleased.md
          fi
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          COMMIT_MSG="Release version $VERSION

          - Created versions/$VERSION.md
          - Updated CHANGELOG.md"
          
          if [ "$CHANGELOG_SOURCE" == "unreleased" ]; then
            COMMIT_MSG="$COMMIT_MSG
          - Cleared versions/unreleased.md"
          else
            COMMIT_MSG="$COMMIT_MSG
          - Changelog from PR description"
          fi
          
          COMMIT_MSG="$COMMIT_MSG
          
          Commit: ${{ env.commit_sha }}"
          
          echo "$COMMIT_MSG" | git commit -F -
      
      - name: Push changes
        if: steps.run_changelog.outputs.has_content == 'true' && steps.run_changelog.outputs.version != '' && env.TARGET_BRANCH != ''
        run: |
          if [ "${{ github.event_name }}" == "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "Cannot push to tag, changes should be on a branch"
            exit 1
          else
            # Debug: Check if bypass token secret exists and has content
            echo "=== Bypass Token Debug ==="
            BYPASS_TOKEN="${{ secrets.CHANGELOG_BYPASS_TOKEN }}"
            TOKEN_LENGTH=${#BYPASS_TOKEN}
            
            if [ -n "$BYPASS_TOKEN" ] && [ "$TOKEN_LENGTH" -gt 0 ]; then
              echo "‚úÖ CHANGELOG_BYPASS_TOKEN secret is set (length: $TOKEN_LENGTH)"
              echo "Using bypass token for push"
              git remote set-url origin https://${BYPASS_TOKEN}@github.com/${{ github.repository }}.git
              # Verify remote URL was set (without exposing token)
              REMOTE_URL=$(git remote get-url origin)
              echo "Remote URL configured: ${REMOTE_URL%%@*}"
            else
              echo "‚ùå CHANGELOG_BYPASS_TOKEN secret is NOT set or is EMPTY (length: $TOKEN_LENGTH)"
              echo ""
              echo "Troubleshooting:"
              echo "  1. Check that CHANGELOG_BYPASS_TOKEN is set as an organization secret"
              echo "  2. Verify the secret has a value (not just whitespace)"
              echo "  3. Ensure the secret name matches exactly: CHANGELOG_BYPASS_TOKEN"
              echo "  4. For org secrets, verify the repository has access to org secrets"
              echo ""
              echo "Using default GITHUB_TOKEN for push"
              echo "Note: GITHUB_TOKEN may not have bypass permissions"
            fi
            echo "Target branch: ${{ env.TARGET_BRANCH }}"
            echo "Repository: ${{ github.repository }}"
            git push origin HEAD:${{ env.TARGET_BRANCH }}
          fi
      
      - name: Create summary
        if: always()
        run: |
          if [ "${{ steps.run_changelog.outputs.has_content }}" == "true" ] && [ -n "${{ steps.run_changelog.outputs.version }}" ]; then
            echo "‚úÖ Successfully released version ${{ steps.run_changelog.outputs.version }}"
            echo "üìù Created versions/${{ steps.run_changelog.outputs.version }}.md"
            echo "üìã Updated CHANGELOG.md"
            CHANGELOG_SOURCE="${{ steps.run_changelog.outputs.changelog_source }}"
            if [ "$CHANGELOG_SOURCE" == "pr" ]; then
              echo "üìÑ Changelog source: PR description"
            elif [ "$CHANGELOG_SOURCE" == "unreleased" ]; then
              echo "üìÑ Changelog source: versions/unreleased.md"
              echo "üßπ Cleared versions/unreleased.md"
            else
              echo "üìÑ Changelog source: $CHANGELOG_SOURCE"
            fi
            echo "üîó Commit: ${{ env.commit_sha }}"
            echo "üìå Version bump: ${{ steps.run_changelog.outputs.version_bump }}"
            echo "üîß Action source: Referenced from TechnicalDocumentation"
          else
            echo "‚ö†Ô∏è No changelog content found or version not determined"
            echo "Changelog source: ${{ steps.run_changelog.outputs.changelog_source }}"
            echo "Has content: ${{ steps.run_changelog.outputs.has_content }}"
            echo "Version: ${{ steps.run_changelog.outputs.version }}"
            echo "Skipping version release"
          fi
